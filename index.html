<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercices ‚Äî Verbes italiens (QCM / Saisie libre)</title>
  <style>
    :root{
      --bg:#0b1224; --panel:#0f172a; --card:#101a33; --ink:#eaf0fb; --muted:#9fb0c7;
      --brand:#38bdf8; --brand2:#a78bfa; --good:#22c55e; --bad:#ef4444; --border:#1d2b4f;
      --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.35)
    }
    html,body{margin:0; background:
      radial-gradient(1200px 600px at 10% -10%, #152244 0%, transparent 60%),
      radial-gradient(900px 600px at 100% 0%, #1b2c52 0%, transparent 55%),
      linear-gradient(180deg, var(--bg), #0e162c);
      color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    *,*:before,*:after{box-sizing:border-box}

    header{padding:26px 16px 8px; text-align:center}
    header h1{margin:0 0 6px; font-size:1.6rem}
    header p{margin:0; color:var(--muted)}

    .wrap{max-width:1000px; margin:0 auto; padding:14px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .panel header{padding:14px 16px; text-align:left; border-bottom:1px solid var(--border)}
    .panel header h2{margin:0; font-size:1.05rem}

    .grid{display:grid; gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#152346; border:1px solid #1b2b58; color:#cfe8ff; font-weight:700}
    .chip input, select{accent-color:var(--brand)}

    .verb-list{display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px}
    .verb{display:flex; align-items:flex-start; gap:10px; padding:12px 14px; background:#0f1a33; border:1px solid #13244a; border-radius:12px}
    .verb input{accent-color:var(--brand); margin-top:2px}
    .verb .vcol{display:flex; flex-direction:column; line-height:1.15}
    .verb .it{font-weight:800; font-size:1rem}
    .verb .fr{color:var(--muted); font-size:.9rem}

    .bar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; padding:10px; background:#0d1832; border:1px solid var(--border); border-radius:12px}
    .bar .counters{display:flex; gap:10px; font-weight:900}

    button{appearance:none; background:linear-gradient(180deg, var(--brand), #119bd4); color:#fff; border:0; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; box-shadow:var(--shadow); cursor:pointer; transition:.15s}
    button.ghost{background:#162549}
    button:active{transform:translateY(1px)}
    @media(hover:hover){button:hover{filter:brightness(1.07); transform:translateY(-1px)}}

    .question{font-size:1.05rem; font-weight:800}
    .choices{display:grid; gap:10px; margin-top:12px}
    @media(min-width:720px){.choices{grid-template-columns:1fr 1fr}}
    .choice{display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0f1a33; border:1px solid #13244a; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer}
    .choice.correct{outline:2px solid var(--good)}
    .choice.wrong{outline:2px solid var(--bad)}
    .choice.debug-hint{outline:2px dashed var(--good); box-shadow:0 0 0 2px rgba(34,197,94,.15) inset}

    .feedback{margin-top:10px; font-weight:800}
    .ok{color:var(--good)} .ko{color:var(--bad)}

    .history{display:grid; gap:8px}
    .hist-item{display:grid; gap:6px; border:1px dashed #1b2b58; border-radius:10px; padding:10px}
    .hist-head{display:flex; justify-content:space-between; gap:8px; font-weight:800}
    .hist-head .ok{background:#10361f; padding:2px 8px; border-radius:999px}
    .hist-head .ko{background:#3a0d13; padding:2px 8px; border-radius:999px}
    .hist-body{color:var(--muted)}

    .debug-ans{margin-top:8px; color:var(--good); font-weight:800}

    .hidden{display:none!important}
    .note{color:var(--muted); font-size:.9rem}
    .warn{background:#3a0d13; color:#ffd6db; border:1px solid #7a1a23; padding:10px 12px; border-radius:12px}

    /* petite "modale" inline pour la capacit√© */
    .capacity{border:1px solid #6b1b1b; background:#2a1010; color:#ffd6d9; border-radius:12px; padding:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
    .capacity .actions{display:flex; gap:8px}
  </style>
  <style>
    /* === Styles ajout√©s pour les reprises (subsidiaries) === */
    .card.subs{background:#2b2300; border-color:#5a4500; box-shadow:0 0 0 2px rgba(250,204,21,.12) inset}
    .badge-subs{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; border:1px solid #5a4500; background:#2b2300; color:#facc15; font-size:.75rem; font-weight:900}
    .card.subs .choice{background:#1b1603; border-color:#3b2f03}
    .hist-head .subs{background:#2b2300; border:1px solid #5a4500; color:#facc15; padding:2px 8px; border-radius:999px}
  </style>
</head>
<body>
  <header>
    <h1>Exercices ‚Äî Verbes italiens</h1>
    <p>Choisis tes verbes (charg√©s depuis <code>verbs.json</code>), ton mode (QCM ou saisie libre) et lance une s√©rie sans r√©p√©tition. Correction imm√©diate + historique.</p>
  </header>

  <div class="wrap">
    <!-- CONFIGURATION -->
    <section class="panel" id="config">
      <header><h2>‚öôÔ∏è Configuration de l'exercice</h2></header>
      <div class="grid">
        <div class="card">
          <div class="controls" style="margin-bottom:10px">
            <label class="chip"><input type="radio" name="mode" value="qcm" checked> QCM</label>
            <label class="chip"><input type="radio" name="mode" value="saisie"> Saisie libre</label>
            <label class="chip" title="Toujours actif pour CHIAMARSI"><input type="checkbox" id="fullForm" checked> Forme compl√®te (pronoms)</label>
            
            <label class="chip" title="Affiche la bonne r√©ponse en vert pour contr√¥le"><input type="checkbox" id="debugMode"> Mode debug</label>
          </div>
          <p class="note">Place un fichier <code>verbs.json</code> √† c√¥t√© de cette page pour alimenter la liste. Sans ce fichier, le d√©marrage sera bloqu√©.</p>
          <div id="loadWarn" class="warn hidden">‚ùå Impossible de charger <code>verbs.json</code>. Ajoute le fichier puis recharge la page.</div>
          <div id="capacity" class="capacity hidden" role="alert">
            <div id="capText">Capacit√©</div>
            <div class="actions">
              <button id="capUnique" class="ghost">Rester √† P (uniques)</button>
              <button id="capReview" class="ghost">Atteindre N avec r√©visions</button>
              <button id="capCancel" class="ghost">Annuler</button>
            </div>
          </div>
        </div>
        <div class="card">
          <strong>Verbes √† inclure :</strong>
          <div id="verbsList" class="verb-list" aria-live="polite"></div>
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin:12px 14px 16px">
        <button id="start" disabled>üöÄ Lancer</button>
      </div>
    </section>

    <!-- QUIZ -->
    <section class="panel hidden" id="quiz">
      <header>
        <h2>üß™ Exercice en cours</h2>
        <div class="bar" role="status">
          <div class="counters">
            <div>Progression : <span id="progress">1/20</span></div>
            <div>Bonnes r√©ponses : <span id="score">0</span></div>
          </div>
          <div style="display:flex; gap:8px">
            <button id="reset" class="ghost">‚Üª Reset</button>
            <button id="backToConfig" class="ghost">‚öôÔ∏è Options</button>
          </div>
        </div>
      </header>
      <div class="grid">
        <div class="card" id="currentQ">
          <div class="question" id="qText">‚Ä¶</div>
          <div id="modeQCM" class="choices hidden" role="listbox" aria-label="Choix de r√©ponse"></div>
          <div id="modeInput" class="hidden">
            <form id="freeForm" autocomplete="off" style="display:flex; gap:8px; margin-top:12px">
              <input id="answer" type="text" inputmode="latin" placeholder="√âcris ta r√©ponse en italien" style="flex:1; padding:12px 14px; border-radius:12px; background:#0f1a33; border:1px solid #13244a; color:var(--ink); font-weight:700" />
              <button>Valider</button>
            </form>
          </div>
          <div class="debug-ans hidden" id="debugAns"></div>
          <div class="feedback" id="feedback"></div>
        </div>
        <div class="card">
          <strong>Historique</strong>
          <div id="history" class="history" aria-live="polite"></div>
          <div id="endActions" class="hidden" style="margin-top:10px; display:flex; gap:10px">
            <button id="replay">üîÅ Rejouer</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
  // ===== Utilitaires =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const normalize = s => (s||"")
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/‚Äô/g, "'")
    .replace(/\s+/g,' ')
    .trim();

  // ===== Chargement JSON externe uniquement =====
  async function loadVerbs(){
    const warn = $('#loadWarn');
    try{
      const res = await fetch('verbs.json', {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(!data || !Array.isArray(data.verbs)) throw new Error('format');
      warn.classList.add('hidden');
      return data;
    }catch(e){
      warn.classList.remove('hidden');
      return null;
    }
  }

  // ===== √âtat global =====
  const STATE = {
    data:null,
    selectedVerbIds:new Set(),
    mode:'qcm', // 'qcm' | 'saisie'
    fullForm:true,
    total:20,
    idx:0,
    good:0,
    history:[],
    current:null,
    queue:[], // file d'attente des questions
    uniquePool:[], // toutes les questions uniques possibles pour cette config
    repeats:{enabled:false, target:0, scheduled:0, minGap:4, scheduledKeys:new Set()},
    debug:false
  };

  // ===== Construction UI config =====
  function renderVerbChecks(verbs){
    const box = $('#verbsList'); box.innerHTML = '';
    verbs.forEach(v => {
      const id = `verb-${v.id}`;
      const el = document.createElement('label');
      el.className = 'verb';
      el.innerHTML = `<input type="checkbox" id="${id}" value="${v.id}"> <div class="vcol"><div class="it">${v.it}</div><div class="fr">‚Äî ${v.fr}</div></div>`;
      box.appendChild(el);
      el.querySelector('input').addEventListener('change', onVerbToggle);
    });
    onVerbToggle();
  }
  function onVerbToggle(){
    const any = $$('#verbsList input[type="checkbox"]').some(c => c.checked);
    $('#start').disabled = !any || !STATE.data; // bloque si pas de donn√©es
    $('#capacity').classList.add('hidden');
  }

  function readConfig(){
    STATE.mode = ($$('input[name="mode"]').find(r=>r.checked)||{}).value || 'qcm';
    STATE.fullForm = $('#fullForm').checked;
    STATE.selectedVerbIds = new Set(
      $$('#verbsList input[type="checkbox"]').filter(c=>c.checked).map(c=>c.value)
    );
  }

  // ===== Debug auth =====
  function ensureDebugAuth(){
    const wantDebug = $('#debugMode').checked;
    const persisted = sessionStorage.getItem('debug') === '1';
    if(!wantDebug){
      sessionStorage.removeItem('debug');
      STATE.debug = false;
      return true;
    }
    if(persisted){ STATE.debug = true; return true; }
    const pwd = prompt('Mot de passe debug :');
    if(pwd === null) return false; // annul√©
    if(pwd === 'birdy'){
      sessionStorage.setItem('debug','1');
      STATE.debug = true;
      return true;
    } else {
      alert('Mot de passe incorrect');
      STATE.debug = false;
      return false;
    }
  }

  // ===== G√©n√©ration: pool unique & file =====
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

  function buildUniquePool(){
    const pool = [];
    const seen = new Set();
    const verbs = STATE.data.verbs.filter(v=> STATE.selectedVerbIds.has(v.id));
    for(const v of verbs){
      for(const f of v.forms){
        const mustFull = v.id === 'chiamarsi' ? true : STATE.fullForm;
        const answer = (mustFull ? f.full : f.it).split('|')[0].trim();
        const key = `${v.id}:${f.person}:${mustFull}`;
        if(seen.has(key)) continue;
        seen.add(key);
        pool.push({ key, verb:v, form:f, prompt:f.fr, answer, mustFull });
      }
    }
    return pool;
  }

  function prepareQueueUniqueOnly(N){
    STATE.uniquePool = buildUniquePool();
    const P = STATE.uniquePool.length;
    const n = Math.min(N, P);
    STATE.queue = shuffle(STATE.uniquePool).slice(0, n);
    STATE.total = n;
    STATE.repeats = {enabled:false, target:0, scheduled:0, minGap:4, scheduledKeys:new Set()};
  }

  function prepareQueueWithReviews(N){
    STATE.uniquePool = buildUniquePool();
    const P = STATE.uniquePool.length;
    STATE.queue = shuffle(STATE.uniquePool); // toutes les uniques d'abord
    STATE.total = N;
    STATE.repeats = {enabled:true, target:Math.max(0, N-P), scheduled:0, minGap:4, scheduledKeys:new Set()};
  }

  // ===== QCM choices =====
  function makeQcmChoices(target){
    const { verb, form, answer, mustFull } = target;
    const fmt = f => (mustFull || verb.id==='chiamarsi') ? f.full : f.it;

    const choices = new Set([ normalize(answer) ]);
    const labels = [ answer ];

    const sameVerb = shuffle(verb.forms.filter(f=>f!==form)).slice(0,2);
    sameVerb.forEach(f=>{
      let label = fmt(f).split('|')[0].trim();
      if(!choices.has(normalize(label))){ choices.add(normalize(label)); labels.push(label); }
    });

    const otherVerbs = shuffle(STATE.data.verbs.filter(v=>v.id!==verb.id && STATE.selectedVerbIds.has(v.id)));
    for(const v of otherVerbs){
      const f = pick(v.forms);
      const lbl = (v.id==='chiamarsi' ? f.full : (STATE.fullForm ? f.full : f.it)).split('|')[0].trim();
      if(!choices.has(normalize(lbl))){ choices.add(normalize(lbl)); labels.push(lbl); }
      if(labels.length>=5) break;
    }

    while(labels.length<5){
      const f = pick(verb.forms);
      const lbl = fmt(f).split('|')[0].trim();
      if(!choices.has(normalize(lbl))){ choices.add(normalize(lbl)); labels.push(lbl); }
    }

    return shuffle(labels);
  }

  // ===== Demande du nombre de questions =====
  function getRequestedCount(){
    const def = parseInt(sessionStorage.getItem('qCount')||'20',10);
    const input = prompt('Combien de questions ? (ex: 20)', isNaN(def)?'20':String(def));
    if(input===null) return null; // annul√©
    const n = parseInt(input,10);
    if(!Number.isFinite(n) || n<=0){ alert('Entr√©e invalide.'); return null; }
    sessionStorage.setItem('qCount', String(n));
    return n;
  }

  // ===== M√©canique du quiz =====
  async function startQuiz(){
    readConfig();

    // Auth debug avant tout
    if(!ensureDebugAuth()) return;

    const requested = (typeof getRequestedCount==='function' ? getRequestedCount() : 20);
    if(requested===null) return; // annul√©

    // capacit√©
    const P = (STATE.selectedVerbIds.size) * 6; // 6 personnes par verbe
    if(P === 0){ return; }
    if(requested <= P){
      prepareQueueUniqueOnly(requested);
      launch();
    }else{
      // Afficher la "modale" de capacit√© et revenir √† la config
      $('#quiz').classList.add('hidden');
      $('#config').classList.remove('hidden')
      $('#capText').textContent = `Vous avez s√©lectionn√© ${STATE.selectedVerbIds.size} verbe(s) ‚Üí ${P} questions uniques possibles. Voulez‚Äëvous :`;
      $('#capacity').classList.remove('hidden');
      // Brancher actions
      $('#capUnique').onclick = ()=>{ prepareQueueUniqueOnly(requested); launch(); };
      $('#capReview').onclick = ()=>{ prepareQueueWithReviews(requested); launch(); };
      $('#capCancel').onclick = ()=>{ $('#capacity').classList.add('hidden'); };
    }
  }

  function launch(){
    $('#capacity').classList.add('hidden');
    STATE.idx = 0; STATE.good = 0; STATE.history = [];
    $('#config').classList.add('hidden');
    $('#quiz').classList.remove('hidden');
    $('#history').innerHTML = ''; $('#endActions').classList.add('hidden');
    updateCounters();
    askNext();
  }

  function updateCounters(){
    $('#progress').textContent = `${Math.min(STATE.idx+1, STATE.total)}/${STATE.total}`;
    $('#score').textContent = STATE.good;
  }

  function askNext(){
    if(STATE.idx>=STATE.total){
      $('#qText').textContent = 'Termin√© !';
      $('#modeQCM').classList.add('hidden');
      $('#modeInput').classList.add('hidden');
      $('#feedback').innerHTML = `<span class="ok">Score final : ${STATE.good}/${STATE.total}</span>`;
      $('#endActions').classList.remove('hidden');
      return;
    }

    if(STATE.queue.length===0){
      // plus d'unique, si r√©visions activ√©es mais pas assez planifi√©es, compl√©ter depuis l'historique
      if(STATE.repeats.enabled && STATE.repeats.scheduled < STATE.repeats.target){
        const need = STATE.repeats.target - STATE.repeats.scheduled;
        const wrongs = STATE.history.filter(h=>!h.ok).map(h=>h.src);
        const pool = wrongs.length? wrongs : STATE.history.map(h=>h.src);
        const toAdd = shuffle(pool).slice(0, need);
        STATE.queue.push(...toAdd.map(cloneItem));
        STATE.repeats.scheduled += toAdd.length;
      }
    }

    STATE.current = STATE.queue.shift();
    const qt = `Comment dit‚Äëon ¬´ ${STATE.current.prompt} ¬ª en italien ?`;
    $('#qText').textContent = qt;
    $('#feedback').textContent = '';

    // Debug hint for input
    const dbg = $('#debugAns');
    if(STATE.debug){ dbg.textContent = `DEBUG ‚Äî r√©ponse attendue : ${STATE.current.answer}`; dbg.classList.remove('hidden'); }
    else { dbg.classList.add('hidden'); }

    if(STATE.mode==='qcm'){
      const box = $('#modeQCM'); box.innerHTML = ''; box.classList.remove('hidden');
      $('#modeInput').classList.add('hidden');
      const options = makeQcmChoices(STATE.current);
      options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.type='button'; btn.className='choice'; btn.innerHTML = `<span>${opt}</span>`;
        if(STATE.debug && normalize(opt)===normalize(STATE.current.answer)){
          btn.classList.add('debug-hint');
        }
        btn.addEventListener('click', ()=> handleQcmClick(opt, btn));
        box.appendChild(btn);
      });
    }else{
      $('#modeQCM').classList.add('hidden');
      $('#modeInput').classList.remove('hidden');
      $('#answer').value = '';
      $('#answer').focus();
    }
  }

  function cloneItem(item){
    return { key:item.key+":rep", verb:item.verb, form:item.form, prompt:item.prompt, answer:item.answer, mustFull:item.mustFull };
  }

  function recordHistory(isCorrect, given, correct){
    STATE.history.unshift({ q: `¬´ ${STATE.current.prompt} ¬ª`, given, correct, ok:isCorrect, src: STATE.current });
    const item = document.createElement('div');
    item.className = 'hist-item';
    item.innerHTML = `
      <div class="hist-head">
        <div>${STATE.history[0].q}</div>
        <div class="${isCorrect? 'ok':'ko'}">${isCorrect?'‚úÖ R√©ussi':'‚ùå Faux'}</div>
      </div>
      <div class="hist-body">
        Ta r√©ponse : <strong>${given||'‚Äî'}</strong><br>
        ${isCorrect? '' : `Bonne r√©ponse : <strong>${correct}</strong>`}
      </div>`;
    $('#history').prepend(item);
  }

  function scheduleReviewIfNeeded(isCorrect){
    if(!STATE.repeats.enabled) return;
    if(isCorrect) return;
    if(STATE.repeats.scheduled >= STATE.repeats.target) return;
    const key = STATE.current.key;
    if(STATE.repeats.scheduledKeys.has(key)) return;
    // ins√©rer apr√®s un espacement minimal
    const insertAt = Math.min(STATE.repeats.minGap-1, STATE.queue.length);
    STATE.queue.splice(insertAt, 0, cloneItem(STATE.current));
    STATE.repeats.scheduled++;
    STATE.repeats.scheduledKeys.add(key);
  }

  async function afterAnswer(isCorrect){
    if(isCorrect){ STATE.good++; }
    scheduleReviewIfNeeded(isCorrect);
    STATE.idx++;
    updateCounters();
    await sleep(600);
    askNext();
  }

  // QCM
  function handleQcmClick(choice, btn){
    const correct = STATE.current.answer;
    const ok = normalize(choice)===normalize(correct);
    $$('#modeQCM .choice').forEach(b=> b.disabled=true);
    btn.classList.add(ok? 'correct':'wrong');
    $('#feedback').innerHTML = ok ? '<span class="ok">‚úÖ Correct</span>' : `<span class="ko">‚ùå Faux</span> ‚Üí Bonne r√©ponse : <strong>${correct}</strong>`;
    recordHistory(ok, choice, correct);
    afterAnswer(ok);
  }

  // Saisie libre
  $('#freeForm')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val = $('#answer').value;
    const correct = STATE.current.answer;
    const ok = normalize(val)===normalize(correct);
    $('#feedback').innerHTML = ok ? '<span class="ok">‚úÖ Correct</span>' : `<span class="ko">‚ùå Faux</span> ‚Üí Bonne r√©ponse : <strong>${correct}</strong>`;
    recordHistory(ok, val, correct);
    afterAnswer(ok);
  });

  // Boutons
  $('#start').addEventListener('click', startQuiz);
  $('#reset').addEventListener('click', startQuiz);
  $('#backToConfig').addEventListener('click', ()=>{
    $('#quiz').classList.add('hidden');
    $('#config').classList.remove('hidden');
  });
  $('#replay').addEventListener('click', startQuiz);

  // Mode & options
  $$('input[name="mode"]').forEach(r=> r.addEventListener('change', ()=>{
    STATE.mode = ($$('input[name="mode"]').find(x=>x.checked)||{}).value || 'qcm';
  }));
  $('#fullForm').addEventListener('change', ()=>{ STATE.fullForm = $('#fullForm').checked; });

  // Debug checkbox persistence
  $('#debugMode').addEventListener('change', ()=>{
    if(!$('#debugMode').checked){ sessionStorage.removeItem('debug'); STATE.debug=false; }
  });

  // Initialisation
  (async function init(){
    // restore debug flag
    if(sessionStorage.getItem('debug')==='1'){ $('#debugMode').checked = true; STATE.debug=true; }

    STATE.data = await loadVerbs();
    if(!STATE.data){ $('#start').disabled = true; return; }
    renderVerbChecks(STATE.data.verbs);
  })();
  </script>
  <script>
  // === Extension logique: reprises par temps de r√©flexion + marquage jaune ===
  (function(){
    if(typeof window.STATE === 'undefined') return;
    // √âtend l'√©tat
    if(!STATE.repeatedFrom) STATE.repeatedFrom = new Set();
    if(typeof STATE.qStart === 'undefined') STATE.qStart = 0;

    // Utilitaires s√ªrs
    const has = (fn)=> typeof fn === 'function';

    // Pr√©parer la file: uniques d'abord
    function prepareQueue(N){
      if(!has(window.buildUniquePool)) return;
      STATE.uniquePool = buildUniquePool();
      const P = STATE.uniquePool.length;
      const base = has(window.shuffle) ? shuffle(STATE.uniquePool) : STATE.uniquePool.slice();
      STATE.queue = base.slice(0, Math.min(N, P));
      STATE.total = N;
      STATE.repeatedFrom.clear();
    }
    window.prepareQueue = prepareQueue;

    // Ajoute des reprises en fonction du temps de r√©ponse (du plus long au plus court)
    function scheduleSubsidiariesIfNeeded(){
      const remainingNeeded = STATE.total - STATE.idx - STATE.queue.length;
      if(remainingNeeded <= 0) return;
      const candidates = (STATE.history||[])
        .filter(h => h && h.src && !h.src.subsidiary && !STATE.repeatedFrom.has(h.src.key))
        .sort((a,b)=> (b.dur||0) - (a.dur||0));
      const toTake = candidates.slice(0, remainingNeeded);
      const clones = toTake.map(h=>{ STATE.repeatedFrom.add(h.src.key); return Object.assign({}, h.src, {subsidiary:true}); });
      if(has(window.shuffle)) STATE.queue.push(...shuffle(clones)); else STATE.queue.push(...clones);
    }
    window.scheduleSubsidiariesIfNeeded = scheduleSubsidiariesIfNeeded;

    // Remplace askNext pour ins√©rer le marquage jaune + chrono et g√©rer les reprises
    window.askNext = function(){
      if(STATE.idx>=STATE.total){
        document.getElementById('qText').textContent = 'Termin√© !';
        document.getElementById('modeQCM').classList.add('hidden');
        document.getElementById('modeInput').classList.add('hidden');
        document.getElementById('feedback').innerHTML = '<span class="ok">Score final : '+STATE.good+'/'+STATE.total+'</span>';
        document.getElementById('endActions').classList.remove('hidden');
        return;
      }
      if(STATE.queue.length===0){
        scheduleSubsidiariesIfNeeded();
        if(STATE.queue.length===0){
          document.getElementById('qText').textContent = 'Termin√© !';
          document.getElementById('modeQCM').classList.add('hidden');
          document.getElementById('modeInput').classList.add('hidden');
          document.getElementById('feedback').innerHTML = '<span class="ok">Score final : '+STATE.good+'/'+STATE.total+'</span>';
          document.getElementById('endActions').classList.remove('hidden');
          return;
        }
      }

      STATE.current = STATE.queue.shift();
      const card = document.getElementById('currentQ');
      card.classList.toggle('subs', !!STATE.current.subsidiary);
      const badge = STATE.current.subsidiary ? '<span class="badge-subs">SUBSIDIARY</span>' : '';
      const qt = 'Comment dit‚Äëon ¬´ '+STATE.current.prompt+' ¬ª en italien ?';
      document.getElementById('qText').innerHTML = badge+' '+qt;
      document.getElementById('feedback').textContent = '';

      // Debug hint pour saisie libre
      const dbg = document.getElementById('debugAns');
      if(STATE.debug){ dbg.textContent = 'DEBUG ‚Äî r√©ponse attendue : '+STATE.current.answer; dbg.classList.remove('hidden'); } else { dbg.classList.add('hidden'); }

      // d√©marrer le chrono
      STATE.qStart = Date.now();

      if(STATE.mode==='qcm'){
        const box = document.getElementById('modeQCM'); box.innerHTML = ''; box.classList.remove('hidden');
        document.getElementById('modeInput').classList.add('hidden');
        const options = has(window.makeQcmChoices) ? makeQcmChoices(STATE.current) : [STATE.current.answer];
        options.forEach(opt=>{
          const btn = document.createElement('button');
          btn.type='button'; btn.className='choice'; btn.innerHTML = '<span>'+opt+'</span>';
          if(STATE.debug && has(window.normalize) && normalize(opt)===normalize(STATE.current.answer)){
            btn.classList.add('debug-hint');
          }
          btn.addEventListener('click', ()=> handleQcmClick(opt, btn));
          box.appendChild(btn);
        });
      }else{
        document.getElementById('modeQCM').classList.add('hidden');
        document.getElementById('modeInput').classList.remove('hidden');
        const a = document.getElementById('answer'); if(a){ a.value=''; a.focus(); }
      }
    };

    // Remplace recordHistory pour m√©moriser le temps + badge jaune dans l'historique
    window.recordHistory = function(isCorrect, given, correct){
      const dur = Math.max(0, Date.now() - (STATE.qStart||Date.now()));
      const wasSubs = !!STATE.current.subsidiary;
      const idx = STATE.idx + 1;
      STATE.history.unshift({ q: '¬´ '+STATE.current.prompt+' ¬ª', given, correct, ok:isCorrect, src: STATE.current, dur, idx, wasSubs });
      const item = document.createElement('div');
      item.className = 'hist-item';
      const tag = wasSubs ? '<span class="subs">SUBSIDIARY</span>' : '';
      const durSec = (dur/1000).toFixed(1)+'s';
      item.innerHTML = '<div class="hist-head"><div>'+tag+' '+STATE.history[0].q+' ¬∑ <span title="Temps de r√©ponse">'+durSec+'</span></div><div class="'+(isCorrect?'ok':'ko')+'">'+(isCorrect?'‚úÖ R√©ussi':'‚ùå Faux')+'</div></div><div class="hist-body">Ta r√©ponse : <strong>'+(given||'‚Äî')+'</strong><br>'+ (isCorrect?'':'Bonne r√©ponse : <strong>'+correct+'</strong>') +'</div>';
      const hist = document.getElementById('history'); if(hist) hist.prepend(item);
    };

    // Nouveau d√©marrage qui demande le nombre + pr√©pare la file uniques
    function newStartQuiz(){
      if(!has(window.readConfig)) return; readConfig();
      if(!ensureDebugAuth()) return;
      const def = parseInt(sessionStorage.getItem('qCount')||'20',10);
      const input = prompt('Combien de questions ? (ex: 20)', isNaN(def)?'20':String(def));
      if(input===null) return; const n = parseInt(input,10); if(!Number.isFinite(n)||n<=0){ alert('Entr√©e invalide.'); return; }
      sessionStorage.setItem('qCount', String(n));
      prepareQueue(n);
      // launch
      STATE.idx = 0; STATE.good = 0; STATE.history = []; STATE.current = null; STATE.qStart = 0;
      document.getElementById('config').classList.add('hidden');
      document.getElementById('quiz').classList.remove('hidden');
      document.getElementById('history').innerHTML = ''; document.getElementById('endActions').classList.add('hidden');
      document.getElementById('progress').textContent = '1/'+STATE.total; document.getElementById('score').textContent = '0';
      askNext();
    }

    // Rebind des boutons: on clone pour enlever les anciens listeners
    ['start','reset','replay'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return;
      const clone = el.cloneNode(true); el.parentNode.replaceChild(clone, el);
      clone.addEventListener('click', newStartQuiz);
    });
  })();
  </script>
</body>
</html>
